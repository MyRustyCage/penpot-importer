penpot.ui.open("Website Importer","./penpot-importer/",{width:400,height:500});penpot.ui.onMessage(t=>{if(t.type==="import-website"){const e=t.data;if(!e)return;try{C(e),penpot.ui.sendMessage({type:"import-success"})}catch(s){penpot.ui.sendMessage({type:"import-error",error:s instanceof Error?s.message:"Unknown error"})}}});function h(t){return!!(t.text&&t.text.trim().length>0||t.styles.backgroundColor!=="rgba(0, 0, 0, 0)"||t.styles.backgroundImage!=="none"||t.styles.boxShadow!=="none"||t.styles.borderRadius!=="0px"&&parseInt(t.styles.borderRadius)>0||["img","svg","button","a","input","textarea","video"].includes(t.tag)||t.src)}function y(t){var r;const e=[];function s(o){o&&(h(o)&&e.push(o),o.children&&o.children.forEach(a=>s(a)))}return s(t.structure.nav),s(t.structure.header),s(t.structure.main),(r=t.structure.sections)==null||r.forEach(o=>s(o)),s(t.structure.footer),e}function x(t){let e=0,s=0;return t.forEach(r=>{const o=r.geometry.x+r.geometry.width,a=r.geometry.y+r.geometry.height;o>e&&(e=o),a>s&&(s=a)}),{width:Math.max(e,1920),height:Math.max(s,1080)}}function u(t){const e=t.match(/rgba?\((\d+),\s*(\d+),\s*(\d+)(?:,\s*[\d.]+)?\)/);if(e){const r=parseInt(e[1]).toString(16).padStart(2,"0"),o=parseInt(e[2]).toString(16).padStart(2,"0"),a=parseInt(e[3]).toString(16).padStart(2,"0");return`#${r}${o}${a}`}const s=t.match(/rgb\((\d+),\s*(\d+),\s*(\d+)\)/);if(s){const r=parseInt(s[1]).toString(16).padStart(2,"0"),o=parseInt(s[2]).toString(16).padStart(2,"0"),a=parseInt(s[3]).toString(16).padStart(2,"0");return`#${r}${o}${a}`}return t}function b(t){console.log("Parsing gradient:",t);const e=t.match(/linear-gradient\((.*)\)/),s=t.match(/radial-gradient\((.*)\)/);if(!e&&!s)return console.log("No gradient match found"),null;const r=!!e;let o=r?e[1]:s[1],a=180;if(r)if(o.match(/^\d+deg/)){const i=o.match(/^(\d+)deg/);a=parseInt(i[1]),o=o.replace(/^\d+deg,\s*/,"")}else o.startsWith("to right")?(a=90,o=o.replace(/^to right,\s*/,"")):o.startsWith("to left")?(a=270,o=o.replace(/^to left,\s*/,"")):o.startsWith("to top")?(a=0,o=o.replace(/^to top,\s*/,"")):o.startsWith("to bottom")&&(a=180,o=o.replace(/^to bottom,\s*/,""));r||(o=o.replace(/^[^,]*at\s+[^,]+,\s*/,""));const n=[];let c=0,f="";for(let i=0;i<o.length;i++){const l=o[i];if(l==="("&&c++,l===")"&&c--,l===","&&c===0){if(f.trim()){const d=p(f.trim());d&&n.push(d)}f=""}else f+=l}if(f.trim()){const i=p(f.trim());i&&n.push(i)}if(console.log("Parsed stops:",n),n.length<2)return console.log("Not enough color stops"),null;if(n.every(i=>i.offset===null||i.offset===0))n.forEach((i,l)=>{i.offset=l/(n.length-1)});else for(let i=0;i<n.length;i++)n[i].offset===null&&(n[i].offset=i/(n.length-1));if(r){const i=(a-90)*(Math.PI/180);return{type:"linear",startX:.5-Math.cos(i)*.5,startY:.5-Math.sin(i)*.5,endX:.5+Math.cos(i)*.5,endY:.5+Math.sin(i)*.5,width:1,stops:n.map(l=>({color:l.color,offset:l.offset,opacity:1}))}}else return{type:"radial",startX:.5,startY:.5,endX:1,endY:.5,width:1,stops:n.map(i=>({color:i.color,offset:i.offset,opacity:1}))}}function p(t){const e=t.match(/(rgba?\([^)]+\)|hsla?\([^)]+\)|#[0-9a-fA-F]{3,8})/);if(!e)return null;const s=u(e[1]),r=t.match(/(\d+(?:\.\d+)?)%/),o=r?parseFloat(r[1])/100:null;return{color:s,offset:o}}function F(t){const e=t.split(",")[0].replace(/["']/g,"").trim();if(e.startsWith("__")||e.includes("_")){const s=e.match(/__([A-Za-z]+)_/);return s?s[1]:"Work Sans"}return e||"Work Sans"}function S(t){const e=parseInt(t);return e<=400?"400":e>=700?"700":"400"}function g(t){if(t.id&&t.id.trim().length>0)return t.id;if(t.text&&t.text.length>0&&t.text.length<30)return`${t.tag}: ${t.text.substring(0,20)}`;if(t.class&&typeof t.class=="string"&&t.class.length>0)try{const e=t.class.split(" ")[0];return`${t.tag}.${e}`}catch{return t.tag}return t.tag}function I(t){const e=t.styles.zIndex&&t.styles.zIndex!=="auto"?parseInt(t.styles.zIndex):0;if(t.tag==="svg"){const r=penpot.createRectangle();if(r)return r.x=t.geometry.x,r.y=t.geometry.y,r.resize(t.geometry.width,t.geometry.height),r.name=`${g(t)} [SVG]`,r.fills=[{fillColor:"#FFD700",fillOpacity:.3}],console.log("Created SVG placeholder:",t.id),{element:r,isText:!1,zIndex:e}}if(t.text&&t.text.trim().length>0){const r=penpot.createText(t.text);if(r){r.x=t.geometry.x,r.y=t.geometry.y,r.resize(t.geometry.width,t.geometry.height),r.name=g(t);const o=parseInt(t.styles.fontSize);!isNaN(o)&&o>0&&(r.fontSize=o.toString());try{r.fontFamily=F(t.styles.fontFamily)}catch{r.fontFamily="Work Sans"}if(t.styles.fontWeight)try{r.fontWeight=S(t.styles.fontWeight)}catch{r.fontWeight="400"}try{const a=u(t.styles.color);a&&a!=="rgba(0, 0, 0, 0)"?r.fills=[{fillColor:a,fillOpacity:1}]:r.fills=[{fillColor:"#FFFFFF",fillOpacity:1}]}catch{r.fills=[{fillColor:"#FFFFFF",fillOpacity:1}]}return{element:r,isText:!0,zIndex:e}}return null}const s=penpot.createRectangle();if(s){if(s.x=t.geometry.x,s.y=t.geometry.y,s.resize(t.geometry.width,t.geometry.height),s.name=g(t),t.styles.backgroundImage&&(t.styles.backgroundImage.includes("gradient")||t.styles.backgroundImage.includes("-gradient"))){console.log("Found gradient element:",t.id),console.log("Background image:",t.styles.backgroundImage);const r=b(t.styles.backgroundImage);if(r){console.log("Parsed gradient:",r);try{return s.fills=[{fillColorGradient:r}],console.log("✓ Gradient applied successfully"),{element:s,isText:!1,zIndex:e}}catch(o){console.error("✗ Gradient fill failed:",o)}}else console.warn("Failed to parse gradient")}if(t.styles.backgroundColor&&t.styles.backgroundColor!=="rgba(0, 0, 0, 0)"){const r=u(t.styles.backgroundColor),o=parseFloat(t.styles.opacity)||1;s.fills=[{fillColor:r,fillOpacity:o}]}if(t.styles.borderRadius&&t.styles.borderRadius!=="0px"){const r=parseInt(t.styles.borderRadius);!isNaN(r)&&r>0&&(s.borderRadius=r)}return{element:s,isText:!1,zIndex:e}}return null}function C(t){if(!penpot.currentPage)throw new Error("No active page found");const s=y(t),r=x(s),o=penpot.createBoard();if(!o)throw new Error("Failed to create board");o.name=t.metadata.title||"Imported Website",o.resize(r.width,r.height),o.x=0,o.y=0;const a=[],n=50;for(let c=0;c<s.length;c+=n)s.slice(c,c+n).forEach(i=>{const l=I(i);l&&a.push(l)});a.sort((c,f)=>c.isText!==f.isText?c.isText?1:-1:c.zIndex-f.zIndex),a.forEach(c=>o.appendChild(c.element)),penpot.selection=[o]}
