penpot.ui.open("Website Importer","./penpot-importer/",{width:400,height:500});penpot.ui.onMessage(t=>{if(t.type==="import-website"){const i=t.data;if(!i)return;try{z(i),penpot.ui.sendMessage({type:"import-success"})}catch(s){penpot.ui.sendMessage({type:"import-error",error:s instanceof Error?s.message:"Unknown error"})}}});function x(t){return!!(t.text&&t.text.trim().length>0||t.styles.backgroundColor!=="rgba(0, 0, 0, 0)"||t.styles.backgroundImage!=="none"||t.styles.boxShadow!=="none"||t.styles.borderRadius!=="0px"&&parseInt(t.styles.borderRadius)>0||["img","svg","button","a","input","textarea","video"].includes(t.tag)||t.src)}function F(t){var r;const i=[];function s(o){o&&(x(o)&&i.push(o),o.children&&o.children.forEach(n=>s(n)))}return s(t.structure.nav),s(t.structure.header),s(t.structure.main),(r=t.structure.sections)==null||r.forEach(o=>s(o)),s(t.structure.footer),i}function I(t){let i=0,s=0;return t.forEach(r=>{const o=r.geometry.x+r.geometry.width,n=r.geometry.y+r.geometry.height;o>i&&(i=o),n>s&&(s=n)}),{width:Math.max(i,1920),height:Math.max(s,1080)}}function f(t){const i=t.match(/rgba?\((\d+),\s*(\d+),\s*(\d+)(?:,\s*[\d.]+)?\)/);if(i){const r=parseInt(i[1]).toString(16).padStart(2,"0"),o=parseInt(i[2]).toString(16).padStart(2,"0"),n=parseInt(i[3]).toString(16).padStart(2,"0");return`#${r}${o}${n}`}const s=t.match(/rgb\((\d+),\s*(\d+),\s*(\d+)\)/);if(s){const r=parseInt(s[1]).toString(16).padStart(2,"0"),o=parseInt(s[2]).toString(16).padStart(2,"0"),n=parseInt(s[3]).toString(16).padStart(2,"0");return`#${r}${o}${n}`}return t}function S(t){const i=t.split(/,\s*(?:linear|radial|conic)-gradient/).find(o=>o.includes("gradient"))||t,s=i.match(/linear-gradient\(([^)]+)\)/);if(s){const o=s[1];let n=180;o.match(/\d+deg/)?n=parseInt(o.match(/(\d+)deg/)[1]):o.includes("to right")?n=90:o.includes("to left")?n=270:o.includes("to top")?n=0:o.includes("to bottom")&&(n=180);const u=o.split(/,\s*(?=rgba?\(|#|rgb|hsl)/),a=[];for(const c of u){if(c.includes("deg")||c.includes("to "))continue;const g=c.match(/(rgba?\([^)]+\)|hsla?\([^)]+\)|rgb\([^)]+\)|#[0-9a-fA-F]{3,8})/);if(!g)continue;const b=g[1],p=c.match(/(\d+(?:\.\d+)?)(px|%)/);let y=null;p&&p[2]==="%"&&(y=parseFloat(p[1])/100),a.push({color:b,position:y})}if(a.length<2)return null;const e=a.map((c,g)=>({color:f(c.color),offset:c.position!==null?c.position:g/(a.length-1),opacity:1})),l=(n-90)*(Math.PI/180),d=.5;return{type:"linear",startX:.5-Math.cos(l)*d,startY:.5-Math.sin(l)*d,endX:.5+Math.cos(l)*d,endY:.5+Math.sin(l)*d,width:1,stops:e}}const r=i.match(/radial-gradient\(([^)]+)\)/);if(r){const n=r[1].split(/,\s*(?=rgba?\(|#|rgb|hsl)/),u=[];for(const e of n){if(e.includes("at ")&&!e.match(/rgba?\(/))continue;const l=e.match(/(rgba?\([^)]+\)|hsla?\([^)]+\)|rgb\([^)]+\)|#[0-9a-fA-F]{3,8})/);if(!l)continue;const d=l[1],c=e.match(/(\d+(?:\.\d+)?)(px|%)/);let g=null;c&&c[2]==="%"&&(g=parseFloat(c[1])/100),u.push({color:d,position:g})}return u.length<2?null:{type:"radial",startX:.5,startY:.5,endX:1,endY:.5,width:1,stops:u.map((e,l)=>({color:f(e.color),offset:e.position!==null?e.position:l/(u.length-1),opacity:1}))}}return null}function C(t){const i=t.split(",")[0].replace(/["']/g,"").trim();if(i.startsWith("__")||i.includes("_")){const s=i.match(/__([A-Za-z]+)_/);return s?s[1]:"Work Sans"}return i||"Work Sans"}function M(t){const i=parseInt(t);return i<=400?"400":i>=700?"700":"400"}function h(t){if(t.id&&t.id.trim().length>0)return t.id;if(t.text&&t.text.length>0&&t.text.length<30)return`${t.tag}: ${t.text.substring(0,20)}`;if(t.class&&typeof t.class=="string"&&t.class.length>0)try{const i=t.class.split(" ")[0];return`${t.tag}.${i}`}catch{return t.tag}return t.tag}function w(t){const i=t.styles.zIndex&&t.styles.zIndex!=="auto"?parseInt(t.styles.zIndex):0;if(t.tag==="svg"){const r=penpot.createRectangle();if(r)return r.x=t.geometry.x,r.y=t.geometry.y,r.resize(t.geometry.width,t.geometry.height),r.name=`${h(t)} [SVG]`,r.fills=[{fillColor:"#FFD700",fillOpacity:.3}],console.log("Created SVG placeholder:",t.id),{element:r,isText:!1,zIndex:i}}if(t.text&&t.text.trim().length>0){const r=penpot.createText(t.text);if(r){r.x=t.geometry.x,r.y=t.geometry.y,r.resize(t.geometry.width,t.geometry.height),r.name=h(t);const o=parseInt(t.styles.fontSize);!isNaN(o)&&o>0&&(r.fontSize=o.toString());try{r.fontFamily=C(t.styles.fontFamily)}catch{r.fontFamily="Work Sans"}if(t.styles.fontWeight)try{r.fontWeight=M(t.styles.fontWeight)}catch{r.fontWeight="400"}try{const n=f(t.styles.color);n&&n!=="rgba(0, 0, 0, 0)"?r.fills=[{fillColor:n,fillOpacity:1}]:r.fills=[{fillColor:"#FFFFFF",fillOpacity:1}]}catch{r.fills=[{fillColor:"#FFFFFF",fillOpacity:1}]}return{element:r,isText:!0,zIndex:i}}return null}const s=penpot.createRectangle();if(s){if(s.x=t.geometry.x,s.y=t.geometry.y,s.resize(t.geometry.width,t.geometry.height),s.name=h(t),t.styles.backgroundImage&&(t.styles.backgroundImage.includes("gradient")||t.styles.backgroundImage.includes("-gradient"))){console.log("Found gradient element:",t.id),console.log("Background image:",t.styles.backgroundImage);const r=S(t.styles.backgroundImage);if(r){console.log("Parsed gradient:",r);try{return s.fills=[{fillColorGradient:r}],console.log("✓ Gradient applied successfully"),{element:s,isText:!1,zIndex:i}}catch(o){console.error("✗ Gradient fill failed:",o)}}else console.warn("Failed to parse gradient")}if(t.styles.backgroundColor&&t.styles.backgroundColor!=="rgba(0, 0, 0, 0)"){const r=f(t.styles.backgroundColor),o=parseFloat(t.styles.opacity)||1;s.fills=[{fillColor:r,fillOpacity:o}]}if(t.styles.borderRadius&&t.styles.borderRadius!=="0px"){const r=parseInt(t.styles.borderRadius);!isNaN(r)&&r>0&&(s.borderRadius=r)}return{element:s,isText:!1,zIndex:i}}return null}function z(t){if(!penpot.currentPage)throw new Error("No active page found");const s=F(t),r=I(s),o=penpot.createBoard();if(!o)throw new Error("Failed to create board");o.name=t.metadata.title||"Imported Website",o.resize(r.width,r.height),o.x=0,o.y=0;const n=[],u=50;for(let a=0;a<s.length;a+=u)s.slice(a,a+u).forEach(l=>{const d=w(l);d&&n.push(d)});n.sort((a,e)=>a.isText!==e.isText?a.isText?1:-1:a.zIndex-e.zIndex),n.forEach(a=>o.appendChild(a.element)),penpot.selection=[o]}
